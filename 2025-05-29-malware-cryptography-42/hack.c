/*
* hack.c
* encrypt/decrypt via Speck
* author: @cocomelonc
* https://cocomelonc.github.io/malware/2025/05/29/malware-cryptography-42.html
*/

#include <stdio.h>
#include <stdint.h>
#include <string.h>

#define ROUNDS 27
#define BLOCK_SIZE 16

uint64_t key[2] = {0x1918111009080100, 0x1110980801000908};
uint64_t round_keys[ROUNDS];

uint64_t rol(uint64_t x, int r) {
  return (x << r) | (x >> (64 - r));
}

uint64_t ror(uint64_t x, int r) {
  return (x >> r) | (x << (64 - r));
}

void speck_key_schedule() {
  round_keys[0] = key[0];
  uint64_t b = key[1];
  for (int i = 0; i < ROUNDS - 1; i++) {
    b = (ror(b, 8) + round_keys[i]) ^ i;
    round_keys[i + 1] = rol(round_keys[i], 3) ^ b;
  }
}

void speck_encrypt(uint64_t* x, uint64_t* y) {
  for (int i = 0; i < ROUNDS; i++) {
    *x = (ror(*x, 8) + *y) ^ round_keys[i];
    *y = rol(*y, 3) ^ *x;
  }
}

void speck_decrypt(uint64_t* x, uint64_t* y) {
  for (int i = ROUNDS - 1; i >= 0; i--) {
    *y = ror(*y ^ *x, 3);
    *x = rol((*x ^ round_keys[i]) - *y, 8);
  }
}

int main() {
  unsigned char payload[] =
    "\x6d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x2d\x6d\x65\x6f\x77\x2d\x00";

  printf("original: ");
  for (int i = 0; i < BLOCK_SIZE; i++) printf("%02x ", payload[i]);
  printf("\n");

  speck_key_schedule();
  uint64_t* pt = (uint64_t*)payload;
  speck_encrypt(&pt[0], &pt[1]);

  printf("encrypted: ");
  for (int i = 0; i < BLOCK_SIZE; i++) printf("%02x ", payload[i]);
  printf("\n");

  speck_decrypt(&pt[0], &pt[1]);

  printf("decrypted: ");
  for (int i = 0; i < BLOCK_SIZE; i++) printf("%02x ", payload[i]);
  printf("\n");

  return 0;
}
