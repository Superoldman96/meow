; macOS ARM64: execve("/bin/zsh", ["-c", 'echo "Meow" > /tmp/meow.txt'], NULL)
.global _start

.section __TEXT,__text

.align 2
_start:
  ; x0 = path to "/bin/zsh"
  adrp    x0, fname@page
  add     x0, x0, fname@pageoff

  ; prepare stack space for argv[] (4 pointers: fname, arg1, arg2, NULL)
  sub     sp, sp, #32

  ; argv[0] = "/bin/zsh"
  adrp    x1, fname@page
  add     x1, x1, fname@pageoff
  str     x1, [sp, #0]

  ; argv[1] = "-c"
  adrp    x2, arg1@page
  add     x2, x2, arg1@pageoff
  str     x2, [sp, #8]

  ; argv[2] = "echo \"Meow\" > /tmp/meow.txt"
  adrp    x3, arg2@page
  add     x3, x3, arg2@pageoff
  str     x3, [sp, #16]

  ; argv[3] = NULL
  mov     x4, xzr
  str     x4, [sp, #24]

  ; x1 = argv[]
  mov     x1, sp

  ; x2 = envp = NULL
  mov     x2, xzr

  ; syscall number for execve: 0x200003b (macOS ARM64)
  movz    x16, #0x3b
  movk    x16, #0x2000, lsl #16
  svc     #0x80

  ; if execve fails, exit(1)
  mov     x0, #1
  movz    x16, #0x1
  movk    x16, #0x2000, lsl #16
  svc     #0x80

;; --- data section ---
.align 2
fname:
  .asciz "/bin/zsh"
.align 2
arg1:
  .asciz "-c"
.align 2
arg2:
  .asciz "echo \"Meow\" > /tmp/meow.txt"
