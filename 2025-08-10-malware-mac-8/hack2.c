/*
 * hack2.c
 * find PID on macOS
 * usage: ./hack2 Safari
 * usage: ./hack2 "Google Chrome"
 * usage: ./hack2 /Applications/Safari.app
 * author @cocomelonc
 * https://cocomelonc.github.io/macos/2025/08/10/malware-mac-8.html
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <libproc.h>
#include <unistd.h>
#include <ctype.h>

static int icaseeq(const char *a, const char *b) {
  for (;; a++, b++) {
    int ca = tolower((unsigned char)*a);
    int cb = tolower((unsigned char)*b);
    if (ca != cb) return 0;
    if (ca == 0)   return 1;
  }
}

int main(int argc, char **argv) {
  const char *target = (argc > 1) ? argv[1] : "Calculator";

  pid_t pids[8192];
  int bytes = proc_listpids(PROC_ALL_PIDS, 0, pids, sizeof(pids));
  if (bytes <= 0) {
    perror("proc_listpids");
    return 1;
  }

  int count = bytes / (int)sizeof(pid_t);
  for (int i = 0; i < count; i++) {
    pid_t pid = pids[i];
    if (pid <= 0) continue;

    char name[PROC_PIDPATHINFO_MAXSIZE] = {0};
    char path[PROC_PIDPATHINFO_MAXSIZE] = {0};

    // procname
    if (proc_name(pid, name, sizeof(name)) <= 0) continue;
    // fullpath (sometimes not work!)
    proc_pidpath(pid, path, sizeof(path));

    int match = 0;
    if (icaseeq(name, target)) match = 1;
    else if (path[0] != '\0' && strcasestr(path, target)) match = 1;

    if (match) {
      printf("PID %d\tname=\"%s\"\tpath=\"%s\"\n", pid, name, path);
    }
  }
  return 0;
}
